###################################
#
# make start-all
#
# docker exec -it wavs bash
#
###################################

services:
  wavs:
    image: "ghcr.io/lay3rlabs/wavs:apr-30-fix-general"
    container_name: "wavs"
    stop_signal: SIGKILL
    network_mode: "host"
    env_file: "./.env"
    ports:
      - "8000:8000"
    environment:
      WAVS_HOME: "/wavs/packages/wavs"
      WAVS_CLI_HOME: "/wavs/packages/cli"
      WAVS_AGGREGATOR_HOME: "/wavs/packages/aggregator"
    command: ["wavs"]
    volumes:
      - "./:/wavs"
      - "./.docker:/root/wavs/cli/"

  aggregator:
    image: "ghcr.io/lay3rlabs/wavs:apr-30-fix-general"
    depends_on: ["wavs"]
    container_name: "wavs-aggregator"
    stop_signal: SIGKILL
    env_file: "./.env"
    ports:
      - "8001:8001"
    command: ["wavs-aggregator"]
    volumes:
      - ".:/wavs"
    network_mode: "host"

  ipfs:
    image: "ipfs/kubo:v0.34.1"
    container_name: "ipfs"
    stop_signal: SIGKILL
    network_mode: "host"
    ports:
      - "4001:4001"
      - "4001:4001/udp"
      - "8080:8080"
      - "5001:5001"
    command: ["daemon", "--offline"]

  warg-registry:
    image: "ghcr.io/reecepbcups/registry:0.0.1"
    container_name: "warg-registry"
    environment:
      WARG_OPERATOR_KEY: ecdsa-p256:I+UlDo0HxyBBFeelhPPWmD+LnklOpqZDkrFP5VduASk=
      WARG_NAMESPACE: example
      WARG_CONTENT_BASE_URL: http://localhost
    ports:
      - 8090:8090
    volumes:
      - content:/var/lib/warg-server/data
    depends_on:
      fix-permission:
        condition: service_completed_successfully

  fix-permission:
    image: busybox
    command: ["sh", "-c", "chown -R 1000:1000 /var/lib/warg-server/data"]
    volumes:
      - content:/var/lib/warg-server/data

volumes:
  content:
